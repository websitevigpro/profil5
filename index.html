<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Anggota</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif;}
    body {background:#f4f6f9; color:#333;}
    /* Login */
    .container {display:flex; justify-content:center; align-items:center; height:100vh; padding:20px;}
    .login-box {background:#fff; width:100%; max-width:360px; padding:30px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.1);}
    .login-box h2 {margin-bottom:20px; text-align:center; font-weight:600; color:#1e293b;}
    .login-box input {width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:10px; transition:0.3s;}
    .login-box input:focus {border-color:#1e293b; outline:none; box-shadow:0 0 0 2px rgba(30,41,59,0.2);}
    .login-box button {width:100%; padding:12px; background:#1e293b; color:#fff; font-weight:600; border:none; border-radius:10px; cursor:pointer; transition:0.3s;}
    .login-box button:hover {background:#334155; transform:translateY(-2px);}
    /* Loading */
    #loadingOverlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); display:none; justify-content:center; align-items:center; z-index:1000;}
    .spinner {width:60px; height:60px; border:6px solid #ccc; border-top:6px solid #1e293b; border-radius:50%; animation:spin 1s linear infinite;}
    @keyframes spin {100%{transform:rotate(360deg)}}
    /* Sidebar */
    .sidebar {width:240px; background:#1e293b; color:#fff; height:100vh; position:fixed; top:0; left:0; padding:20px; display:none; z-index:900;}
    .sidebar h2 {text-align:center; margin-bottom:30px; font-size:20px; font-weight:600;}
    .sidebar ul {list-style:none;}
    .sidebar ul li {margin:15px 0;}
    .sidebar ul li a {color:#fff; text-decoration:none; display:block; padding:12px; border-radius:8px; font-weight:500; transition:0.3s;}
    .sidebar ul li a:hover {background:#334155; padding-left:20px;}
    .close-btn {display:block; text-align:right; margin-bottom:20px; cursor:pointer; font-size:18px;}
    /* Main dashboard */
    .main {margin-left:240px; padding:25px; display:none;}
    .header {display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;}
    .header h1 {font-size:24px; font-weight:600; color:#1e293b;}
    .header button {padding:10px 16px; background:#1e293b; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:500; transition:0.3s;}
    .header button:hover {background:#334155;}
    .cards {display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-top:25px;}
    .card {background:#fff; padding:25px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.08); text-align:center; transition:0.3s;}
    .card:hover {transform:translateY(-5px); box-shadow:0 10px 20px rgba(0,0,0,0.15);}
    .card h3 {font-size:18px; color:#555; margin-bottom:10px;}
    .card p {font-size:20px; font-weight:600; color:#1e293b;}
    /* Profile */
    .profile {background:#fff; padding:20px; margin-top:25px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.08);}
    .profile h2 {margin-bottom:15px; font-size:20px; color:#1e293b;}
    .profile p {margin:6px 0; color:#444;}
    /* Table */
    .table-section {background:#fff; padding:20px; margin-top:25px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.08);}
    .table-section h2 {margin-bottom:15px;}
    table {width:100%; border-collapse:collapse;}
    th, td {padding:12px; border-bottom:1px solid #eee; text-align:left;}
    th {background:#f9fafb; font-weight:600;}
    tr:hover {background:#f3f4f6;}
    /* Announcement */
    .announcement {background:#fff; padding:20px; margin-top:25px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.08);}
    .announcement h2 {margin-bottom:15px;}
    .announcement ul {list-style:disc; margin-left:20px;}
    .announcement ul li {margin:8px 0; color:#444;}
    /* Grafik */
    #chartTeraktif {width:100% !important; height:300px !important;}
    /* Responsive */
    @media(max-width:768px){
      .sidebar {width:220px; position:fixed; left:-220px; transition:0.3s;}
      .sidebar.active {left:0;}
      .main {margin-left:0; padding:15px;}
      .header h1 {font-size:20px;}
      .cards {grid-template-columns:1fr;}
      table {font-size:14px;}
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay"><div class="spinner"></div></div>

  <!-- Login Form -->
  <div class="container" id="loginForm">
    <div class="login-box">
      <h2>Login Anggota</h2>
      <input type="text" id="username" placeholder="Nama">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()">Login</button>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="close-btn" onclick="toggleSidebar()">‚ùå</div>
    <h2 id="sidebarName">Anggota</h2>
    <ul id="menuList">
      <li><a href="#">üè† Dashboard</a></li>
      <li><a href="absen.html">üë§ Presensi</a></li>
      <li><a href="#statistik">üìä Statistik</a></li>
      <li><a href="#tabel">üìã Data Anggota</a></li>
      <li><a href="#pengumuman">üì¢ Pengumuman</a></li>
      <li><a href="#" onclick="logout()">üö™ Logout</a></li>
    </ul>
  </div>

  <!-- Dashboard -->
  <div class="main" id="dashboard">
    <div class="header">
      <h1 id="welcomeName">Dashboard Anggota</h1>
      <button onclick="toggleSidebar()">‚ò∞ Menu</button>
    </div>

    <!-- Grafik Garis Anggota Teraktif -->
    <div class="table-section" id="grafikTeraktif" style="overflow-x:auto;">
      <h2>Anggota Teraktif</h2>
      <div style="min-width:800px;">
        <canvas id="chartTeraktif"></canvas>
      </div>
    </div>

    <!-- Pengumuman -->
    <div class="announcement" id="pengumuman">
      <h2>Pengumuman</h2>
      <ul id="listPengumuman"><li>Loading...</li></ul>
    </div>

    <!-- Statistik -->
    <div class="cards" id="statistik">
      <div class="card"><h3>Total Anggota</h3><p id="totalAnggota">...</p></div>
      <div class="card"><h3>Anggota Aktif</h3><p id="anggotaAktif">...</p></div>
      <div class="card"><h3>Acara Terdekat</h3><p id="acaraTerdekat">...</p></div>
    </div>

    <!-- Profil -->
    <div class="profile" id="profil">
      <h2>Profil Anggota</h2>
      <p><b>Nama:</b> <span id="profilNama">-</span></p>
      <p><b>Email:</b> <span id="profilEmail">-</span></p>
      <p><b>Status:</b> <span id="profilStatus">-</span></p>
    </div>

    <!-- Data Anggota -->
    <div class="table-section" id="tabel">
      <h2>Data Anggota</h2>
      <div style="overflow-x:auto;">
        <table>
          <thead><tr><th>Nama</th><th>Email</th><th>Status</th></tr></thead>
          <tbody id="tableAnggota"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzuIY8hCKXd1LH-EYA5lg3T0e5zaVKeegokJRqmKZbKhQPvqffhqYvLmsqAkP4KH8x5/exec";
    const webAppUrlGrafik = "https://script.google.com/macros/s/AKfycbwgoH-npxmz7r-KN364hRkJ-8TQKpabZGBqGyVBHuFHDv742Z7bxuUL3JI4jfqEml3I4A/exec";

    window.onload = () => {
      const user = localStorage.getItem("loggedInUser");
      if(user) showDashboard(user);
    }

    function toggleSidebar(){document.getElementById("sidebar").classList.toggle("active");}
    function showLoading(show){document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";}

    function login(){
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      if(!username || !password){ alert("Isi semua data!"); return; }
      showLoading(true);

      fetch(webAppUrl, { method:"POST", body:JSON.stringify({username,password}) })
      .then(res => res.json())
      .then(data => {
        if(data.success){
          localStorage.setItem("loggedInUser", data.name);
          localStorage.setItem("profilEmail", data.email);
          localStorage.setItem("profilStatus", data.status);
          showDashboard(data.name);
        } else {
          showLoading(false);
          alert(data.message);
        }
      }).catch(err=>{
        showLoading(false);
        alert("Gagal login: "+err);
      });
    }

    function showDashboard(name){
      document.getElementById("loginForm").style.display="none";
      document.getElementById("dashboard").style.display="block";
      document.getElementById("sidebar").style.display="block";
      document.getElementById("sidebarName").innerText=name;
      document.getElementById("welcomeName").innerText="Halo, "+name;

      document.getElementById("profilNama").innerText = localStorage.getItem("loggedInUser") || "-";
      document.getElementById("profilEmail").innerText = localStorage.getItem("profilEmail") || "-";
      document.getElementById("profilStatus").innerText = localStorage.getItem("profilStatus") || "-";

      startAutoLogout(); // mulai hitung auto logout

      showLoading(true);
      fetch(webAppUrl)
        .then(res=>res.json())
        .then(data=>{
          if(data.total_anggota){
            document.getElementById("totalAnggota").innerText = data.total_anggota+" Orang";
            document.getElementById("anggotaAktif").innerText = data.anggota_aktif+" Orang";
            document.getElementById("acaraTerdekat").innerText = data.acara_terdekat;

            const tbody=document.getElementById("tableAnggota");
            tbody.innerHTML="";
            data.anggota.forEach(a=>{
              tbody.innerHTML+=`<tr><td>${a.nama}</td><td>${a.email}</td><td>${a.status}</td></tr>`;
            });

            const ul=document.getElementById("listPengumuman");
            ul.innerHTML="";
            data.pengumuman.forEach(p=>{ ul.innerHTML+=`<li>${p}</li>`; });

            const status = (localStorage.getItem("profilStatus") || "").toLowerCase();
            let kasLink = "";
            if(status==="admin"||status==="bendahara") kasLink="kas.html";
            else if(status==="anggota") kasLink="kasanggota.html";
            if(kasLink){
              const menuList=document.getElementById("menuList");
              if(!document.getElementById("kasMenu")){
                const li=document.createElement("li");
                li.id="kasMenu";
                li.innerHTML=`<a href="${kasLink}">üí∞ Kas Vigpro</a>`;
                menuList.insertBefore(li,menuList.lastElementChild);
              }
            }
          }

          fetch(webAppUrlGrafik).then(res=>res.json()).then(grafik=>{
            if(grafik.ranking) renderGrafikTeraktif(grafik.ranking);
            showLoading(false);
          }).catch(err=>{console.error("Gagal ambil grafik:",err); showLoading(false);});
        })
        .catch(err=>{console.error("Error ambil data dashboard:",err); showLoading(false);});
    }

    function renderGrafikTeraktif(ranking){
      const labels = ranking.map(r => r.nama);
      const totals = ranking.map(r => r.total);
      const ctx = document.getElementById("chartTeraktif").getContext("2d");

      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, "rgba(59,130,246,0.7)");
      gradient.addColorStop(1, "rgba(16,185,129,0.1)");

      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Jumlah Kehadiran",
            data: totals,
            fill: true,
            backgroundColor: gradient,
            borderColor: "#3b82f6",
            borderWidth: 3,
            tension: 0.35,
            pointBackgroundColor: "#10b981",
            pointBorderColor: "#065f46",
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 9,
            pointHoverBackgroundColor: "#3b82f6",
            pointHoverBorderColor: "#1e40af"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true,
              position: "top",
              labels: { color: "#1e293b", font: { weight: "600" } }
            },
            title: {
              display: true,
              text: "üìà Kehadiran 21 Anggota Aktif",
              font: { size: 20, weight: "bold" },
              color: "#1e293b",
              padding: { top: 15, bottom: 20 }
            },
            tooltip: {
              enabled: true,
              usePointStyle: true,
              mode: "nearest",
              intersect: true,
              backgroundColor: "rgba(30,41,59,0.9)",
              titleFont: { size: 14, weight: "bold" },
              bodyFont: { size: 13 },
              padding: 10,
              callbacks: {
                labelPointStyle: () => ({ pointStyle: "circle", rotation: 0 }),
                label: (ctx) => ` ${ctx.raw} kali hadir`
              }
            },
            datalabels: {
              display: true,
              anchor: "end",
              align: "top",
              color: "#1e293b",
              font: { weight: "bold" }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1, color: "#374151" },
              grid: { color: "#e5e7eb" }
            },
            x: {
              ticks: { color: "#374151", font: { weight: "500" } },
              grid: { display: false }
            }
          },
          interaction: { mode: "nearest", axis: "x", intersect: true },
          animation: { duration: 2000, easing: "easeOutCubic" }
        },
        plugins: [ChartDataLabels]
      });
    }

    function logout(){
      localStorage.removeItem("loggedInUser");
      localStorage.removeItem("profilEmail");
      localStorage.removeItem("profilStatus");
      location.reload();
    }

    // === AUTO LOGOUT ===
    let autoLogoutTimer;
    const autoLogoutDuration = 5 * 60 * 1000; // 5 menit

    function resetAutoLogout(){
      clearTimeout(autoLogoutTimer);
      autoLogoutTimer = setTimeout(()=>{
        alert("Sesi berakhir, Anda akan logout otomatis.");
        logout();
      }, autoLogoutDuration);
    }

    function startAutoLogout(){
      resetAutoLogout();
      ["click","mousemove","keypress","scroll"].forEach(evt=>{
        document.addEventListener(evt, resetAutoLogout);
      });
    }
  </script>
</body>
</html>
